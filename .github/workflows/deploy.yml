name: Deploy to Heroku

on:
  push:
    branches:
      - main
  pull_request:
    types: [closed]
    branches:
      - main

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    # Only deploy on:
    # 1. Direct push to main
    # 2. Merged PR to main (with automated label for auto-merge feature)
    if: |
      github.event_name == 'push' ||
      (github.event.pull_request.merged == true)

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for Heroku deploy

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests before deployment
        env:
          NODE_ENV: test
        run: npm test

      - name: Deploy to Heroku
        uses: akhileshns/heroku-deploy@v3.13.15
        with:
          heroku_api_key: ${{ secrets.HEROKU_API_KEY }}
          heroku_app_name: ${{ secrets.HEROKU_APP_NAME }}
          heroku_email: ${{ secrets.HEROKU_EMAIL }}
          branch: main

      - name: Wait for deployment
        run: sleep 30

      - name: Health check
        run: |
          APP_URL="https://${{ secrets.HEROKU_APP_NAME }}.herokuapp.com"
          echo "Checking health at $APP_URL/health"

          # Try health check endpoint
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$APP_URL/health" || echo "000")

          if [ "$STATUS" = "200" ] || [ "$STATUS" = "404" ]; then
            echo "‚úÖ Deployment successful (status: $STATUS)"
            exit 0
          else
            echo "::warning::Health check returned status $STATUS"
            # Don't fail deployment, just warn
            exit 0
          fi

      - name: Update Linear issue (if automated PR)
        if: |
          github.event_name == 'pull_request' &&
          github.event.pull_request.merged == true &&
          contains(github.event.pull_request.labels.*.name, 'automated')
        uses: actions/github-script@v7
        env:
          LINEAR_API_KEY: ${{ secrets.LINEAR_API_KEY }}
        with:
          script: |
            const prBody = context.payload.pull_request.body || '';
            const linearMatch = prBody.match(/Linear: https:\/\/linear\.app\/[^/]+\/issue\/([A-Z]+-\d+)/);

            if (linearMatch && process.env.LINEAR_API_KEY) {
              const issueId = linearMatch[1];
              console.log(`Found Linear issue: ${issueId}`);

              // Update Linear issue status to "Deployed"
              const linearApi = 'https://api.linear.app/graphql';
              const query = `
                mutation {
                  issueUpdate(
                    id: "${issueId}",
                    input: {
                      stateId: "deployed"
                    }
                  ) {
                    success
                  }
                }
              `;

              try {
                const response = await fetch(linearApi, {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                    'Authorization': process.env.LINEAR_API_KEY
                  },
                  body: JSON.stringify({ query })
                });

                if (response.ok) {
                  console.log('‚úÖ Linear issue updated to Deployed status');
                } else {
                  console.log('‚ö†Ô∏è Failed to update Linear issue status');
                }
              } catch (error) {
                console.log('‚ö†Ô∏è Error updating Linear:', error.message);
              }
            } else {
              console.log('No Linear issue found in PR body or LINEAR_API_KEY not set');
            }

      - name: Notify deployment success
        if: success()
        run: |
          echo "üöÄ Deployment to Heroku completed successfully!"
          echo "App URL: https://${{ secrets.HEROKU_APP_NAME }}.herokuapp.com"

      - name: Notify deployment failure
        if: failure()
        run: |
          echo "::error::Deployment failed. Please check the logs."
          exit 1
