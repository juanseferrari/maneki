# VEP OCR Service Setup Instructions

This document explains the new VEP (Volante Electrónico de Pago) processing feature that has been added to your bank statement processor.

## What was implemented

A specialized OCR service for processing VEP documents (Argentinian electronic payment vouchers) that automatically:
1. Detects VEP documents
2. Extracts all relevant payment information
3. Stores it in a structured database
4. Displays it in a user-friendly format in the frontend

## Files Created

### 1. Database Schema
- **File**: `supabase-veps-schema.sql`
- **Purpose**: Creates the `veps` table with all required fields
- **Action Required**: Run this SQL script in your Supabase SQL Editor

### 2. VEP OCR Service
- **File**: `services/vep-ocr.service.js`
- **Purpose**: Specialized OCR engine for extracting VEP data
- **Features**:
  - Automatic VEP document detection
  - Extracts 12 key fields from VEP documents
  - Parses line items (detailed breakdown of payments)
  - Handles Argentine number formats (1.234,56)
  - Calculates confidence scores

### 3. VEP Processor Service
- **File**: `services/vep-processor.service.js`
- **Purpose**: Orchestrates VEP file processing
- **Features**:
  - Coordinates parsing, extraction, and storage
  - Updates file metadata
  - Handles processing errors

### 4. Updated Services
- **File**: `services/supabase.service.js`
- **Added Methods**:
  - `saveVep()` - Save VEP data to database
  - `getVeps()` - Get all VEPs
  - `getVepByFile()` - Get VEP by file ID
  - `getVepByNumber()` - Get VEP by VEP number
  - `updateFileDocumentType()` - Mark files as VEP or bank statement

- **File**: `services/processor.service.js`
- **Enhancement**: Automatically detects document type and routes to appropriate processor

### 5. API Endpoints
- **File**: `server.js`
- **New Endpoints**:
  - `GET /api/veps` - Get all VEPs
  - `GET /api/veps/file/:fileId` - Get VEP by file ID
  - `GET /api/veps/:nroVep` - Get VEP by VEP number

### 6. Frontend Updates
- **File**: `public/js/upload.js`
- **New Features**:
  - Document type badges (VEP vs Bank Statement)
  - VEP-specific view button
  - `viewVep()` function to display VEP details
  - `createVepDetailsHtml()` to format VEP data

- **File**: `public/css/style.css`
- **New Styles**: Complete VEP display styling with responsive design

## VEP Fields Extracted

The system extracts the following information from VEP documents:

1. **Nro VEP** - VEP Number (e.g., "1528847816")
2. **Organismo Recaudador** - Collection Agency (e.g., "ARCA")
3. **Tipo de Pago** - Payment Type
4. **Descripción Reducida** - Short Description (e.g., "SIJPDJ09/25")
5. **CUIT** - Tax ID (e.g., "30-71600516-6")
6. **Concepto** - Concept
7. **Subconcepto** - Sub-concept
8. **Período** - Period (e.g., "2025-09")
9. **Generado por el Usuario** - Generated by User ID
10. **Fecha Generación** - Generation Date
11. **Día de Expiración** - Expiration Date
12. **Importe Total a Pagar** - Total Amount to Pay

Additionally, it extracts line items with:
- Description
- Code
- Amount

## Setup Steps

### 1. Create Database Table
```bash
# Open Supabase SQL Editor and run:
cat supabase-veps-schema.sql
```

This will:
- Create the `veps` table
- Add the `document_type` column to the `files` table
- Set up indexes and triggers

### 2. No Code Changes Required
The system is already integrated! The upload process now:
1. Accepts PDF files
2. Automatically detects if it's a VEP or bank statement
3. Routes to the appropriate processor
4. Displays with the correct UI

### 3. Test It
1. Start your server: `npm start`
2. Upload the VEP PDF you provided ("Fix F931 2025 09 vep.pdf")
3. Wait for processing to complete
4. Click "View VEP" button to see the extracted data

## How It Works

### Upload Flow
```
User uploads PDF
    ↓
File is saved to Supabase Storage
    ↓
Text is extracted from PDF
    ↓
System detects document type (VEP or Bank Statement)
    ↓
If VEP:
    → vep-ocr.service extracts structured data
    → vep-processor.service saves to database
    → File is marked as document_type='vep'
    ↓
Frontend displays with VEP-specific UI
```

### Data Storage
```
files table (metadata)
    ↓
    └── document_type = 'vep' or 'bank_statement'

veps table (VEP data)
    ├── Core fields (CUIT, VEP number, amounts, etc.)
    ├── items_detalle (JSONB array of line items)
    └── raw_data (JSONB of processing metadata)
```

## Frontend Display

### File List
- VEP files show a yellow "VEP" badge
- Bank statements show a blue "Bank Statement" badge
- VEP files have a "View VEP" button
- Bank statements have a "View Transactions" button

### VEP Modal
When clicking "View VEP", users see:
- **Header Section**: VEP number and agency (highlighted in blue)
- **Payment Information**: All payment details in a grid
- **Dates Section**: Generation and expiration dates
- **Line Items Table**: Breakdown of all payment concepts
- **Total Amount**: Large, prominent display of total to pay

## Extending the System

### Adding New VEP Fields
1. Update `supabase-veps-schema.sql` with new column
2. Add extraction logic in `services/vep-ocr.service.js`
3. Update `services/supabase.service.js` to save new field
4. Modify `public/js/upload.js` to display new field

### Improving OCR Accuracy
Edit `services/vep-ocr.service.js`:
- Add more regex patterns for field extraction
- Improve date/amount parsing
- Add validation rules

### Custom Styling
Edit `public/css/style.css` under the "VEP Styles" section

## Troubleshooting

### VEP Not Detected
- Check that the document contains keywords like "VEP", "Volante Electrónico de Pago", or "ARCA"
- View browser console for detection logs

### Low Confidence Score
- Indicates some fields couldn't be extracted
- Check the raw PDF text extraction quality
- May need to adjust regex patterns for specific VEP formats

### Frontend Not Showing VEP Data
- Verify the database schema was created successfully
- Check browser console for API errors
- Ensure `document_type` column exists in `files` table

## Example VEP Data Structure

```json
{
  "nro_vep": "1528847816",
  "organismo_recaudador": "ARCA",
  "tipo_pago": "Empleadores SICOSS - Saldo DJ",
  "descripcion_reducida": "SIJPDJ09/25",
  "cuit": "30-71600516-6",
  "concepto": "19 OBLIGACION MENSUAL/ANUAL",
  "subconcepto": "19 OBLIGACION MENSUAL/ANUAL",
  "periodo": "2025-09",
  "generado_por_usuario": "20371787373",
  "fecha_generacion": "2025-10-07",
  "dia_expiracion": "2025-11-06",
  "importe_total_pagar": 3204812.48,
  "items_detalle": [
    {
      "descripcion": "CONTRIBUCIONES SEG. SOCIAL",
      "codigo": "351",
      "monto": 1058223.38
    },
    {
      "descripcion": "EMPLEADOR-APORTES SEG. SOCIAL",
      "codigo": "301",
      "monto": 804013.71
    }
  ]
}
```

## Next Steps

1. **Run the database schema** in Supabase
2. **Test with your VEP document**
3. **Monitor the extraction quality** and adjust patterns as needed
4. **Customize the UI** to match your brand if desired

The system is fully functional and ready to process VEP documents alongside bank statements!
